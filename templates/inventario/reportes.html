{% extends 'partials/base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">游늵 Reportes de Inventario</h2>

  <!-- Formulario de filtros -->
  <form method="get"
        id="form-reportes"
        data-api-url="{% url 'inventario:api_categorias' %}"
        class="mb-8 max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-6">

    <!-- Tipo de reporte -->
    <div>
      <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de reporte</label>
      <select name="tipo" id="tipo" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Selecciona tipo</option>
        <option value="general" {% if tipo_reporte == 'general' %}selected{% endif %}>Inventario general</option>
        <option value="movimientos" {% if tipo_reporte == 'movimientos' %}selected{% endif %}>Movimientos</option>
        <option value="resumen_movimientos" {% if tipo_reporte == 'resumen_movimientos' %}selected{% endif %}>Resumen de movimientos</option>
      </select>
    </div>

    <!-- Categor칤a padre -->
    <div>
      <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor칤a padre</label>
      <select name="categoria" id="categoria" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Todas</option>
        {% for cat in categorias_padre %}
          <option value="{{ cat.id }}" {% if filtro_categoria == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Subcategor칤a -->
    <div>
      <label for="subcategoria" class="block text-sm font-medium text-gray-700 mb-1">Subcategor칤a</label>
      <select name="subcategoria" id="subcategoria"
              class="form-control w-full px-3 py-2 border rounded-md"
              data-selected="{{ filtro_subcategoria|default:'' }}">
        <option value="">Todas</option>
      </select>
    </div>

    <!-- Temporada -->
    <div>
      <label for="temporada" class="block text-sm font-medium text-gray-700 mb-1">Temporada</label>
      <select name="temporada" id="temporada" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Todas</option>
        {% for temporada in temporadas %}
          <option value="{{ temporada.id }}" {% if filtro_temporada == temporada.id|stringformat:"s" %}selected{% endif %}>
            {{ temporada.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Ubicaci칩n -->
    <div>
      <label for="ubicacion" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci칩n</label>
      <select name="ubicacion" id="ubicacion" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Todas</option>
        {% for ubicacion in ubicaciones %}
          <option value="{{ ubicacion.id }}" {% if filtro_ubicacion == ubicacion.id|stringformat:"s" %}selected{% endif %}>
            {{ ubicacion.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Due침o -->
    <div>
      <label for="due침o" class="block text-sm font-medium text-gray-700 mb-1">Due침o</label>
      <select name="due침o" id="due침o" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Todos</option>
        {% for emp in due침os %}
          <option value="{{ emp.id }}" {% if filtro_due침o == emp.id|stringformat:"s" %}selected{% endif %}>
            {{ emp.user.get_full_name|default:emp.user.username }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Movimiento -->
    <div>
      <label for="movimiento" class="block text-sm font-medium text-gray-700 mb-1">Tipo de movimiento</label>
      <select name="movimiento" id="movimiento" class="form-control w-full px-3 py-2 border rounded-md">
        <option value="">Todos</option>
        <option value="entrada" {% if filtro_movimiento == 'entrada' %}selected{% endif %}>Entrada</option>
        <option value="salida" {% if filtro_movimiento == 'salida' %}selected{% endif %}>Salida</option>
        <option value="transferencia" {% if filtro_movimiento == 'transferencia' %}selected{% endif %}>Transferencia</option>
        <option value="ajuste" {% if filtro_movimiento == 'ajuste' %}selected{% endif %}>Ajuste</option>
      </select>
    </div>

    <!-- Botones -->
    <div class="sm:col-span-2 flex flex-col gap-4">
      <button type="submit" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
        Generar reporte
      </button>
      <a href="{% url 'inventario:reporte_pdf' %}?tipo={{ tipo_reporte }}{% if filtro_movimiento %}&movimiento={{ filtro_movimiento }}{% endif %}{% if filtro_ubicacion %}&ubicacion={{ filtro_ubicacion }}{% endif %}{% if filtro_categoria %}&categoria={{ filtro_categoria }}{% endif %}{% if filtro_subcategoria %}&subcategoria={{ filtro_subcategoria }}{% endif %}{% if filtro_temporada %}&temporada={{ filtro_temporada }}{% endif %}{% if filtro_dueno %}&due침o={{ filtro_dueno }}{% endif %}"
         target="_blank"
         class="w-full bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900 transition text-center">
        Descargar PDF del reporte
      </a>
    </div>
  </form>

  <!-- Inventario -->
  {% if inventario %}
    <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for item in inventario %}
        <div class="card opacity-0 translate-y-4 bg-white rounded-md shadow-sm p-4 border border-gray-200 hover:shadow-md transition duration-700 ease-out">
          <h3 class="text-base font-semibold text-red-600 mb-2">{{ item.producto_nombre }}</h3>
          {% if item.ubicacion_nombre %}
            <p class="text-sm text-gray-700">Ubicaci칩n: <strong>{{ item.ubicacion_nombre }}</strong></p>
          {% endif %}
          {% if item.due침o_nombre %}
            <p class="text-sm text-gray-700">Due침o: <strong>{{ item.due침o_nombre }}</strong></p>
          {% endif %}
          <p class="text-sm text-gray-700">Cantidad: <strong>{{ item.total }}</strong></p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-gray-500 mt-8">No se encontraron resultados para los filtros seleccionados.</p>
  {% endif %}

  <!-- Movimientos -->
  {% if movimientos %}
    <div class="mt-12">
      <h3 class="text-xl font-semibold mb-4 text-center text-gray-800">游닍 Movimientos registrados</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-md">
          <thead class="bg-gray-100 text-sm text-gray-700">
            <tr>
              <th class="px-4 py-2 text-left">Producto</th>
              <th class="px-4 py-2 text-left">Tipo</th>
              <th class="px-4 py-2 text-left">Cantidad</th>
              <th class="px-4 py-2 text-left">Origen</th>
              <th class="px-4 py-2 text-left">Destino</th>
              <th class="px-4 py-2 text-left">Fecha</th>
            </tr>
          </thead>
          <tbody class="text-sm text-gray-600">
            {% for mov in movimientos %}
              <tr class="border-t"> 
                <td class="px-4 py-2">{{ mov.producto_nombre }}</td>
                <td class="px-4 py-2 capitalize">{{ mov.tipo_valor }}</td>
                <td class="px-4 py-2">{{ mov.cantidad_valor }}</td>
                <td class="px-4 py-2">{{ mov.origen_nombre|default:"-" }}</td>
                <td class="px-4 py-2">{{ mov.destino_nombre|default:"-" }}</td>
                <td class="px-4 py-2">{{ mov.fecha_valor|date:" d/m/Y H:i" }}</td>
              </tr> 
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <p class="text-center text-gray-500 mt-8">No se encontraron movimientos para los filtros seleccionados.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/reportes.js' %}"></script>
{% endblock %}